#################################
#          Shadows             #
#################################

shadow = true;
shadow-radius = 14;
shadow-offset-x = -16;
shadow-offset-y = -16;
shadow-opacity = 0.6;
shadow-red = 0.0;
shadow-green = 0.0;
shadow-blue = 0.0;

# Список исключений для теней
shadow-exclude = [
  "name = 'Notification'",
  "name *= 'VLC'",
  "name *= 'compton'",
  "name *= 'picom'",
  "name *= 'Chromium'",
  "name *= 'Chrome'",
  "name *= 'Dunst'",
  "class_g = 'Conky'",
  "class_g = 'Kodi'",
  "class_g ?= 'Notify-osd'",
  "class_g = 'Cairo-clock'",
  "class_g = 'slop'",
  "class_g = 'Polybar'",
  "class_g = 'tray'",
  "class_g = 'ulauncher'",
  "class_g ?= 'i3-frame'",
  "class_g = 'dmenu'",
  "_GTK_FRAME_EXTENTS@:c",
  "_NET_WM_STATE@:32a *= '_NET_WM_STATE_HIDDEN'",
  "window_type = 'dock'",
  "window_type = 'desktop'",
  "window_type = 'tooltip'",
  "window_type = 'popup_menu'",
  "window_type = 'dropdown_menu'",
  "window_type = 'menu'",
  "window_type = 'utility'"
];

#################################
#           Fading              #
#################################

fading = true;
fade-in-step = 0.03;
fade-out-step = 0.03;
fade-delta = 4;

no-fading-openclose = false;
no-fading-destroyed-argb = true;

fade-exclude = [
  "class_g = 'slop'",
  "class_g = 'rofi'",
  "class_g = 'Dunst'",
  "window_type = 'dock'"
];

#################################
#   Transparency / Opacity      #
#################################

inactive-opacity = 0.92;
active-opacity = 1.0;
frame-opacity = 1.0;
inactive-opacity-override = false;
inactive-dim = 0.0;  # Затемнение неактивных окон

focus-exclude = [
  "class_g = 'Cairo-clock'",
  "class_g = 'Bar'",
  "class_g = 'slop'",
  "class_g = 'tray'",
  "class_g = 'Dunst'",
  "class_g = 'Polybar'",
  "window_type = 'dock'",
  "window_type = 'tooltip'"
];

# Обновленный opacity-rule с дополнениями
opacity-rule = [
  # Терминалы
  "85:class_g = 'Alacritty' && focused",
  "85:class_g = 'Termite' && focused",
  "85:class_g = 'kitty' && focused",
  "85:class_g = 'URxvt' && focused",
  "85:class_g = 'st-256color' && focused",
  "85:class_g = 'XTerm' && focused",
  "52:class_g = 'Alacritty' && !focused",
  "52:class_g = 'kitty' && !focused",
  "52:class_g = 'URxvt' && !focused",
  "52:class_g = 'XTerm' && !focused",
  "52:class_g = 'st-256color' && !focused",
  "52:class_g = 'Termite' && !focused",
  
  # Браузеры
  "95:class_g = 'firefox' && focused",
  "82:class_g = 'firefox' && !focused",
  "99:class_g = 'Google-chrome' && focused",
  "82:class_g = 'Google-chrome' && !focused",
  "95:class_g = 'Chromium' && focused",
  "82:class_g = 'Chromium' && !focused",
  "95:class_g = 'Brave-browser' && focused",
  "82:class_g = 'Brave-browser' && !focused",
  
  # IDE и редакторы
  "95:class_g = 'Code' && focused",
  "70:class_g = 'Code' && !focused",
  "95:class_g = 'code-oss' && focused",
  "82:class_g = 'code-oss' && !focused",
  "95:class_g = 'jetbrains-idea' && focused",
  "85:class_g = 'jetbrains-idea' && !focused",
  "95:class_g = 'Sublime_text' && focused",
  "85:class_g = 'Sublime_text' && !focused",
  "95:class_g = 'geany' && focused",
  "85:class_g = 'geany' && !focused",
  
  # Медиа
  "95:class_g ?= 'Vlc' && focused",
  "85:class_g ?= 'Vlc' && !focused",
  "95:class_g ?= 'mpv' && focused",
  "85:class_g ?= 'mpv' && !focused",
  "82:class_g = 'Spotify'",
  "95:class_g = 'vlc' && focused",
  "85:class_g = 'vlc' && !focused",
  
  # Системные утилиты
  "95:class_g = 'Thunar' && focused",
  "85:class_g = 'Thunar' && !focused",
  "95:class_g = 'Nautilus' && focused",
  "85:class_g = 'Nautilus' && !focused",
  "95:class_g = 'dolphin' && focused",
  "85:class_g = 'dolphin' && !focused",
  "95:class_g = 'pcmanfm' && focused",
  "85:class_g = 'pcmanfm' && !focused",
  
  # Коммуникации
  "82:class_g = 'discord' && focused",
  "75:class_g = 'discord' && !focused",
  "85:class_g = 'TelegramDesktop' && focused",
  "78:class_g = 'TelegramDesktop' && !focused",
  "85:class_g = 'Slack' && focused",
  "78:class_g = 'Slack' && !focused",
  
  # Графика и видео
  "100:class_g = 'Gimp' && focused",
  "88:class_g = 'Gimp' && !focused",
  "82:class_g = 'obs' && focused",
  "75:class_g = 'obs' && !focused",
  "100:class_g = 'Inkscape' && focused",
  "88:class_g = 'Inkscape' && !focused",
  "100:class_g = 'MuseScore' && focused",
  "88:class_g = 'MuseScore' && !focused",
  "100:class_g = 'Blender' && focused",
  "88:class_g = 'Blender' && !focused",
  
  # Виртуализация
  "95:class_g = 'VirtualBox' && focused",
  "88:class_g = 'VirtualBox' && !focused",
  "95:class_g = 'virt-manager' && focused",
  "88:class_g = 'virt-manager' && !focused",
  
  # Лаунчеры и панели
  "82:class_g = 'Rofi'",
  "80:class_g = 'ulauncher'",
  "90:class_g = 'Dunst'",
  "100:class_g = 'Polybar'",
  "100:class_g = 'tray'",
  "100:class_g = 'Plank'",
  
  # Другое
  "100:class_g = 'feh'",
  "95:class_g = 'Zathura' && focused",
  "85:class_g = 'Zathura' && !focused",
  "95:class_g = 'Evince' && focused",
  "85:class_g = 'Evince' && !focused",
  "100:class_g = 'libreoffice' && focused",
  "88:class_g = 'libreoffice' && !focused",
  
  # Игровые приложения (полная непрозрачность)
  "100:class_g = 'steam'",
  "100:class_g = 'Steam'",
  "100:class_g = 'lutris'",
  "100:class_g = 'Minecraft'",
  
  # Исключения (полная непрозрачность)
  "100:window_type = 'dock'",
  "100:window_type = 'desktop'",
  "100:window_type = 'tooltip'"
];

#################################
#     Background-Blurring       #
#################################

blur: {
  method = "dual_kawase";
  strength = 3;
  background = true;
  background-frame = true;
  background-fixed = true;
  blur-background = true;
  blur-background-frame = true;
  blur-background-fixed = true;
  blur-kern = "7x7box";
  blur-size = 12;
  blur-deviation = 5.0;
  blur-strength = 8;
}

# Включить размытие для ARGB окон (важно для прозрачности)
blur-background = true;
blur-background-exclude = [
  "window_type = 'dock'",
  "window_type = 'desktop'",
  "class_g = 'Polybar'",
  "class_g = 'tray'",
  "class_g = 'Plank'",
  "class_g = 'Conky'",
  "class_g = 'ulauncher'",
  "_GTK_FRAME_EXTENTS@:c",
  # Исключения для окон, где размытие выглядит плохо
  "class_g = 'firefox' && window_type = 'utility'",
  "class_g = 'firefox' && window_type = 'popup_menu'",
  # Не исключать терминалы - оставить размытие для них
];

# Альтернативный метод размытия (раскомментировать если dual_kawase не работает)
# blur-method = "kernel";
# blur-kern = "5x5box";
# blur-size = 10;

#################################
#     Rounded Corners           #
#################################

corner-radius = 12;
round-borders = 1;
round-borders-rule = [
  "0:window_type = 'normal'",
  "10:class_g = 'Alacritty'",
  "10:class_g = 'kitty'",
  "10:class_g = 'Code'",
  "10:class_g = 'firefox'"
];

rounded-corners-exclude = [
  "window_type = 'dock'",
  "window_type = 'desktop'",
  "window_type = 'tooltip'",
  "window_type = 'popup_menu'",
  "window_type = 'dropdown_menu'",
  "window_type = 'menu'",
  "class_g = 'Polybar'",
  "class_g = 'tray'",
  "class_g = 'Rofi'",
  "class_g = 'ulauncher'",
  "class_g = 'Dunst'",
  "class_g = 'slop'",
  "class_g = 'conky-semi'",
  # Для окон без заголовков
  "bounding_shaped",
  "!bounding_shaped && rounded_corners"
];

#################################
#       General Settings        #
#################################

backend = "glx";
vsync = true;
mark-wmwin-focused = true;
mark-ovredir-focused = true;
detect-rounded-corners = true;
detect-client-opacity = true;
detect-transient = true;
glx-no-stencil = true;
glx-copy-from-front = false;
use-damage = true;
log-level = "warn";

# Экспериментальные настройки для улучшения производительности
xrender-sync-fence = true;
glx-no-rebind-pixmap = true;
use-ewmh-active-win = true;
unredir-if-possible = false;
unredir-if-possible-delay = 0;
unredir-if-possible-exclude = [];

# Настройки для DBE
dbe = false;
paint-on-overlay = true;

# Настройки для слабого железа (раскомментировать при проблемах)
# glx-use-copysubbuffermesa = true;
# glx-swap-method = "exchange";

#################################
#       Window Types            #
#################################

wintypes:
{
  tooltip = { 
    fade = true; 
    shadow = false; 
    opacity = 0.95; 
    focus = true; 
    blur-background = false;
  };
  dock = { 
    shadow = false; 
    opacity = 1.0; 
    blur-background = false;
  };
  dnd = { 
    shadow = false; 
    blur-background = false;
  };
  popup_menu = { 
    opacity = 0.95; 
    blur-background = true;
    corner-radius = 8;
  };
  dropdown_menu = { 
    opacity = 0.95; 
    blur-background = true;
    corner-radius = 8;
  };
  utility = { 
    opacity = 1.0; 
    blur-background = false;
  };
  normal = { 
    opacity = 1.0; 
    blur-background = true;
  };
  notification = { 
    opacity = 0.95; 
    blur-background = true;
    corner-radius = 8;
  };
  dialog = { 
    opacity = 1.0; 
    blur-background = true;
    corner-radius = 10;
  };
  menu = { 
    opacity = 0.95; 
    blur-background = true;
    corner-radius = 8;
  };
  splash = { 
    opacity = 1.0; 
    blur-background = false;
  };
};

#################################
#       Animations              #
#################################

animations = true;
animation-stiffness = 300.0;
animation-window-mass = 0.5;
animation-dampening = 25.0;
animation-clamping = true;

transition-length = 200;
transition-pow-x = 0.1;
transition-pow-y = 0.1;
transition-pow-w = 0.1;
transition-pow-h = 0.1;

animation-for-open-window = "zoom";
animation-for-unmap-window = "slide-down";
animation-for-transient-window = "slide-down";

#################################
#          Other                #
#################################

daemon = true;
dbus = false;
write-pid-path = "/tmp/picom.pid";

# Клиппинг окон с прозрачностью
clip-shadow-above = true;

# Настройки для tear-free
# vsync-aggressive = true;

# Экспериментальные фичи
experimental-backends = true;